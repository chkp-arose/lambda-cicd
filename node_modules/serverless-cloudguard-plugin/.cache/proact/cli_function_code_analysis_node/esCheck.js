'use strict'

const acorn = require('acorn-loose')
const glob = require('glob')
const fs = require('fs')

function esCheck(filesList, ecmaVersion) {

  let errArray = []
  const globOpts = { nodir: true }
  const acornOpts = { ecmaVersion: ecmaVersion, silent: true }

  filesList.forEach((pattern) => {

    const globbedFiles = glob.sync(pattern, globOpts)

    if (globbedFiles.length === 0) {
      console.log(`ES-Check: Did not find any files to check for ${pattern}.`)
      process.exit(1);
    }

    globbedFiles.forEach((file) => {
      const code = fs.readFileSync(file, 'utf8')

      console.log(`ES-Check: checking ${file}`)
      try {
        acorn.parse(code, acornOpts)
      } catch (err) {
        console.log(`ES-Check: failed to parse file: ${file} \n - error: ${err}`)
        const errorObj = {
          err,
          stack: err.stack,
          file,
        }
        errArray.push(errorObj)
      }
    })
  })

  if (errArray.length > 0) {
    console.log(`ES-Check: there were ${errArray.length} ES version matching errors.`)
    errArray.forEach((o) => {
      console.log(`
          ES-Check Error:
          ----
          · erroring file: ${o.file}
          · error: ${o.err}
          · see the printed err.stack below for context
          ----\n
          ${o.stack}
        `)
    })
    return false;
  }
  console.log('ES-Check: there were no ES version matching errors!');
  return true;
}

module.exports = esCheck;
