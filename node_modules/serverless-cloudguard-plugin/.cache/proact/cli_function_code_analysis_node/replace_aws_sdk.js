const acorn = require("acorn-loose");
const walk = require("acorn-walk");

const new_line = "\n";
const requireFunctions = ['require', '__webpack_require__'];

class RelpaceAwsSdk {

    replace(contents, replace_aws_sdk) {
        let replacedContents = "";
        let lastLocation = 0;
        try {
            walk.simple(acorn.parse(contents), {
                CallExpression(node) {
                    if (node.arguments.length > 0 &&
                        node.arguments[0].type === 'Literal' &&
                        typeof replace_aws_sdk[node.arguments[0].value] !== 'undefined' &&
                        requireFunctions.includes(node.callee.name)) {

                        const part = contents.substring(lastLocation, node.start);
                        replacedContents += part;
                        replacedContents += replace_aws_sdk[node.arguments[0].value];
                        lastLocation = node.end;
                    }
                }
            });
            replacedContents += contents.substr(lastLocation);
        } catch (err) {
            return contents;
        }

        return replacedContents;
    }
}

module.exports = RelpaceAwsSdk;